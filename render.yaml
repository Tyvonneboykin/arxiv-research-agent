services:
  - type: background_worker
    name: arxiv-research-agent
    env: python
    plan: starter
    rootDir: .
    buildCommand: |
      echo "======================================"
      echo "üöÄ COMPREHENSIVE BUILD DEBUG PROCESS"
      echo "======================================"
      
      # Step 1: Environment baseline
      echo "üìã STEP 1: Environment Baseline"
      echo "üè† HOME: $HOME"
      echo "üìÅ PWD: $(pwd)"
      echo "üë§ USER: $(whoami)"
      echo "üñ•Ô∏è OS: $(uname -a)"
      echo "üìç Initial PATH: $PATH"
      echo ""
      
      # Step 2: NVM Setup with detailed logging
      echo "üìã STEP 2: Node.js/NVM Setup"
      echo "üì• Downloading NVM..."
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
      echo "üîß Loading NVM..."
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      echo "‚úÖ NVM loaded, available versions: $(nvm list-remote | tail -5)"
      echo "üì¶ Installing Node.js 20..."
      nvm install 20 && nvm use 20
      echo "‚úÖ Node.js setup complete:"
      echo "  - Node version: $(node --version)"
      echo "  - npm version: $(npm --version)"
      echo "  - NVM DIR: $NVM_DIR"
      echo "  - Current PATH: $PATH"
      echo ""
      
      # Step 3: Claude CLI Installation with extreme logging
      echo "üìã STEP 3: Claude CLI Installation"
      echo "üì¶ Installing @anthropic-ai/claude-code globally..."
      npm install -g @anthropic-ai/claude-code
      INSTALL_EXIT_CODE=$?
      echo "üìä npm install exit code: $INSTALL_EXIT_CODE"
      
      echo "üîç Post-installation discovery:"
      echo "  - which claude: $(which claude || echo 'NOT FOUND')"
      echo "  - npm bin -g: $(npm bin -g || echo 'FAILED')"
      echo "  - npm list -g claude-code: $(npm list -g @anthropic-ai/claude-code || echo 'NOT LISTED')"
      
      # Test CLI immediately after installation
      echo "üß™ Testing Claude CLI immediately:"
      if claude --version >/dev/null 2>&1; then
        echo "‚úÖ Claude CLI test SUCCESS: $(claude --version)"
        CLI_WORKS="true"
        CLI_PATH="$(which claude)"
        CLI_VERSION="$(claude --version)"
      else
        echo "‚ùå Claude CLI test FAILED"
        CLI_WORKS="false"
        CLI_PATH=""
        CLI_VERSION=""
      fi
      echo ""
      
      # Step 4: Comprehensive environment mapping
      echo "üìã STEP 4: Environment Mapping"
      echo "üîç npm global bin contents:"
      NPM_BIN="$(npm bin -g || echo '')"
      if [ -n "$NPM_BIN" ]; then
        echo "  - npm bin -g path: $NPM_BIN"
        echo "  - Contents: $(ls -la "$NPM_BIN" || echo 'DIRECTORY NOT ACCESSIBLE')"
        echo "  - Claude files: $(ls -la "$NPM_BIN" | grep claude || echo 'NO CLAUDE FILES')"
      else
        echo "  - npm bin -g: FAILED"
      fi
      
      echo "üîç Find all claude executables:"
      find /opt /home /root /usr -name 'claude' -type f 2>/dev/null | while read file; do
        echo "  - Found: $file ($(ls -la "$file"))"
      done || echo "  - No claude files found"
      echo ""
      
      # Step 5: Create comprehensive runtime info files
      echo "üìã STEP 5: Creating Runtime Info Files"
      
      # Create build success indicator
      echo "‚úÖ BUILD_SUCCESS" > build_status.txt
      echo "$(date)" > build_timestamp.txt
      
      # Save all critical paths and info
      echo "$CLI_WORKS" > cli_works.txt
      echo "$CLI_PATH" > claude_cli_path.txt
      echo "$CLI_VERSION" > claude_version.txt
      echo "$NPM_BIN" > npm_global_bin.txt
      echo "$(node --version)" > node_version.txt
      echo "$PATH" > build_path.txt
      echo "$NVM_DIR" > nvm_dir.txt
      
      # Create verification summary
      cat > build_summary.txt << EOF
BUILD SUMMARY
=============
Date: $(date)
CLI Works: $CLI_WORKS
CLI Path: $CLI_PATH
CLI Version: $CLI_VERSION
NPM Global Bin: $NPM_BIN
Node Version: $(node --version)
NVM Dir: $NVM_DIR
Build PATH: $PATH
EOF
      
      echo "üíæ Runtime files created:"
      ls -la *.txt
      echo "üìÑ Build summary:"
      cat build_summary.txt
      echo ""
      
      # Step 6: Python setup
      echo "üìã STEP 6: Python Dependencies"
      pip install -r requirements.txt
      python setup.py --verify
      
      # BUILD VERIFICATION MARKER
      echo "BUILD_VERIFICATION_$(date)" > build_marker.txt
      echo "üö® BUILD MARKER CREATED: $(cat build_marker.txt)"
      
      echo "======================================"
      echo "üéâ BUILD PROCESS COMPLETE"
      echo "======================================"
    startCommand: |
      # DEPLOYMENT VERIFICATION MARKER
      echo "DEPLOYMENT_VERIFICATION_$(date)" > deployment_marker.txt
      echo "üö® DEPLOYMENT MARKER CREATED: $(cat deployment_marker.txt)"
      
      echo "======================================"
      echo "üöÄ RUNTIME ENVIRONMENT DEBUG"
      echo "======================================"
      
      export PYTHONPATH="/opt/render/project:/opt/render/project/src:$PYTHONPATH"
      cd /opt/render/project
      
      # Step 1: Runtime environment baseline
      echo "üìã STEP 1: Runtime Environment Baseline"
      echo "üè† HOME: $HOME"
      echo "üìÅ PWD: $(pwd)"
      echo "üë§ USER: $(whoami)"
      echo "üìç Current PATH: $PATH"
      echo ""
      
      # Step 2: Build files verification
      echo "üìã STEP 2: Build Files Verification"
      echo "üìÅ Available files in project root:"
      ls -la *.txt 2>/dev/null || echo "  - No .txt files found"
      
      if [ -f build_summary.txt ]; then
        echo "üìÑ Build Summary:"
        cat build_summary.txt
      else
        echo "‚ùå No build_summary.txt found - build may have failed"
      fi
      echo ""
      
      # Step 3: Load saved build information
      echo "üìã STEP 3: Loading Build Information"
      
      # Check if CLI worked during build
      if [ -f cli_works.txt ]; then
        CLI_WORKED_IN_BUILD="$(cat cli_works.txt)"
        echo "üîß CLI worked in build: $CLI_WORKED_IN_BUILD"
      else
        CLI_WORKED_IN_BUILD="unknown"
        echo "‚ö†Ô∏è No cli_works.txt file"
      fi
      
      # Load saved paths
      SAVED_CLI_PATH=""
      SAVED_NPM_BIN=""
      SAVED_NVM_DIR=""
      SAVED_BUILD_PATH=""
      
      if [ -f claude_cli_path.txt ]; then
        SAVED_CLI_PATH="$(cat claude_cli_path.txt)"
        echo "üìç Saved CLI path: '$SAVED_CLI_PATH'"
      else
        echo "‚ö†Ô∏è No claude_cli_path.txt file"
      fi
      
      if [ -f npm_global_bin.txt ]; then
        SAVED_NPM_BIN="$(cat npm_global_bin.txt)"
        echo "üìç Saved npm bin: '$SAVED_NPM_BIN'"
      else
        echo "‚ö†Ô∏è No npm_global_bin.txt file"
      fi
      
      if [ -f nvm_dir.txt ]; then
        SAVED_NVM_DIR="$(cat nvm_dir.txt)"
        echo "üìç Saved NVM dir: '$SAVED_NVM_DIR'"
      else
        echo "‚ö†Ô∏è No nvm_dir.txt file"
      fi
      
      if [ -f build_path.txt ]; then
        SAVED_BUILD_PATH="$(cat build_path.txt)"
        echo "üìç Saved build PATH: '$SAVED_BUILD_PATH'"
      else
        echo "‚ö†Ô∏è No build_path.txt file"
      fi
      echo ""
      
      # Step 4: Current runtime environment setup
      echo "üìã STEP 4: Runtime Environment Setup"
      
      # Try to recreate Node.js environment
      if [ -n "$SAVED_NVM_DIR" ] && [ -s "$SAVED_NVM_DIR/nvm.sh" ]; then
        export NVM_DIR="$SAVED_NVM_DIR"
        \. "$NVM_DIR/nvm.sh"
        nvm use 20 2>/dev/null || nvm use default 2>/dev/null || true
        echo "‚úÖ NVM loaded from saved dir: $(node --version 2>/dev/null || echo 'FAILED')"
      else
        echo "‚ö†Ô∏è Could not load NVM from saved dir"
        # Fallback to default location
        export NVM_DIR="$HOME/.nvm"
        if [ -s "$NVM_DIR/nvm.sh" ]; then
          \. "$NVM_DIR/nvm.sh"
          nvm use 20 2>/dev/null || nvm use default 2>/dev/null || true
          echo "‚úÖ NVM loaded from default: $(node --version 2>/dev/null || echo 'FAILED')"
        else
          echo "‚ùå NVM not available at runtime"
        fi
      fi
      
      # Reconstruct PATH with saved npm bin
      if [ -n "$SAVED_NPM_BIN" ]; then
        export PATH="$SAVED_NPM_BIN:$PATH"
        echo "‚úÖ Added saved npm bin to PATH: $SAVED_NPM_BIN"
      fi
      
      # Try current npm bin as well
      CURRENT_NPM_BIN="$(npm bin -g 2>/dev/null || echo '')"
      if [ -n "$CURRENT_NPM_BIN" ] && [ "$CURRENT_NPM_BIN" != "$SAVED_NPM_BIN" ]; then
        export PATH="$CURRENT_NPM_BIN:$PATH"
        echo "‚úÖ Added current npm bin to PATH: $CURRENT_NPM_BIN"
      fi
      echo ""
      
      # Step 5: CLI Detection and Testing
      echo "üìã STEP 5: CLI Detection and Testing"
      
      # Method 1: Use saved CLI path
      FINAL_CLI_PATH=""
      if [ -n "$SAVED_CLI_PATH" ] && [ -f "$SAVED_CLI_PATH" ]; then
        echo "‚úÖ Saved CLI path exists: $SAVED_CLI_PATH"
        if "$SAVED_CLI_PATH" --version >/dev/null 2>&1; then
          echo "‚úÖ Saved CLI path works: $("$SAVED_CLI_PATH" --version)"
          FINAL_CLI_PATH="$SAVED_CLI_PATH"
        else
          echo "‚ùå Saved CLI path not executable"
        fi
      else
        echo "‚ùå Saved CLI path not available"
      fi
      
      # Method 2: Current PATH lookup
      if [ -z "$FINAL_CLI_PATH" ]; then
        CURRENT_CLI="$(which claude 2>/dev/null || echo '')"
        if [ -n "$CURRENT_CLI" ]; then
          echo "‚úÖ Found CLI in current PATH: $CURRENT_CLI"
          if "$CURRENT_CLI" --version >/dev/null 2>&1; then
            echo "‚úÖ Current CLI works: $("$CURRENT_CLI" --version)"
            FINAL_CLI_PATH="$CURRENT_CLI"
          else
            echo "‚ùå Current CLI not executable"
          fi
        else
          echo "‚ùå No CLI found in current PATH"
        fi
      fi
      
      # Method 3: Manual search
      if [ -z "$FINAL_CLI_PATH" ]; then
        echo "üîç Searching for claude executable manually..."
        for search_path in "$SAVED_NPM_BIN/claude" "$CURRENT_NPM_BIN/claude" "/opt/render/.nvm/versions/node/v20.18.0/bin/claude" "/root/.nvm/versions/node/v20.18.0/bin/claude"; do
          if [ -f "$search_path" ]; then
            echo "  - Found: $search_path"
            if "$search_path" --version >/dev/null 2>&1; then
              echo "  - ‚úÖ Works: $("$search_path" --version)"
              FINAL_CLI_PATH="$search_path"
              break
            else
              echo "  - ‚ùå Not executable"
            fi
          fi
        done
      fi
      
      # Set environment variable for SDK
      if [ -n "$FINAL_CLI_PATH" ]; then
        export CLAUDE_CLI_PATH="$FINAL_CLI_PATH"
        echo "‚úÖ Final CLAUDE_CLI_PATH: $CLAUDE_CLI_PATH"
      else
        echo "‚ùå No working Claude CLI found"
      fi
      echo ""
      
      # Step 6: Environment summary
      echo "üìã STEP 6: Environment Summary"
      echo "üîß Node.js: $(node --version 2>/dev/null || echo 'NOT AVAILABLE')"
      echo "üì¶ npm: $(npm --version 2>/dev/null || echo 'NOT AVAILABLE')"
      echo "ü§ñ Claude CLI: ${CLAUDE_CLI_PATH:-'NOT FOUND'}"
      echo "üìç Final PATH: $PATH"
      echo ""
      
      echo "======================================"
      echo "üöÄ STARTING ARXIV RESEARCH AGENT"
      echo "======================================"
      
      # Start the agent
      python src/research_agent.py --once
    envVars:
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: ARXIV_AGENT_EMAIL_USERNAME
        value: donvon@vonbase.com
      - key: ARXIV_AGENT_EMAIL_FROM
        value: donvon@vonbase.com
      - key: ARXIV_AGENT_LOG_LEVEL
        value: INFO
      - key: ARXIV_OUTPUT_PATH
        value: /tmp/arxiv_output
      - key: RENDER_SERVICE_TYPE
        value: background_worker
    healthCheckPath: /health
    region: oregon
    autoDeploy: true