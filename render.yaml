services:
  - type: background_worker
    name: arxiv-research-agent
    env: python
    plan: starter
    rootDir: .
    buildCommand: |
      echo "üì¶ Setting up mixed Python/Node.js environment..."
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
      export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install 20 && nvm use 20
      echo "üì¶ Installing Claude Code CLI..."
      npm install -g @anthropic-ai/claude-code
      echo "‚úÖ Claude CLI installed: $(claude --version)"
      echo "üîç Discovering Claude CLI installation paths..."
      echo "üìç which claude: $(which claude)"
      echo "üìç npm bin -g: $(npm bin -g)"
      echo "üìç ls npm global bin: $(ls -la $(npm bin -g) | grep claude || echo 'claude not found')"
      echo "üìç NODE_PATH: $NODE_PATH"
      echo "üìç NVM_DIR: $NVM_DIR"
      echo "üìç Current PATH: $PATH"
      echo "üìç All claude files: $(find /opt /home /root -name 'claude' -type f 2>/dev/null || echo 'none found')"
      echo "üíæ Saving CLI path for runtime..."
      echo "$(which claude)" > claude_cli_path.txt
      echo "$(npm bin -g)" > npm_global_bin.txt
      echo "$(node --version)" > node_version.txt
      echo "$PATH" > build_path.txt
      echo "‚úÖ CLI path saved: $(cat claude_cli_path.txt)"
      echo "üì¶ Installing Python dependencies..."
      pip install -r requirements.txt
      echo "üîç Verifying Python setup..."
      python setup.py --verify
    startCommand: |
      export PYTHONPATH="/opt/render/project:/opt/render/project/src:$PYTHONPATH"
      cd /opt/render/project
      echo "üöÄ Starting ArXiv Research Agent with Claude Code SDK analysis..."
      
      # Load saved build-time CLI path information
      echo "üìã Loading saved CLI paths from build..."
      if [ -f claude_cli_path.txt ]; then
        SAVED_CLI_PATH="$(cat claude_cli_path.txt)"
        echo "üìç Saved CLI path: $SAVED_CLI_PATH"
      else
        echo "‚ö†Ô∏è No saved CLI path found"
        SAVED_CLI_PATH=""
      fi
      
      if [ -f npm_global_bin.txt ]; then
        SAVED_NPM_BIN="$(cat npm_global_bin.txt)"
        echo "üìç Saved npm global bin: $SAVED_NPM_BIN"
      else
        echo "‚ö†Ô∏è No saved npm bin path found"
        SAVED_NPM_BIN=""
      fi
      
      # Enhanced Node.js environment setup
      echo "üîß Setting up Node.js environment..."
      export NVM_DIR="$HOME/.nvm"
      if [ -s "$NVM_DIR/nvm.sh" ]; then
        \. "$NVM_DIR/nvm.sh"
        nvm use 20 2>/dev/null || nvm use default 2>/dev/null || true
        echo "‚úÖ NVM loaded, Node version: $(node --version 2>/dev/null || echo 'Not available')"
      else
        echo "‚ö†Ô∏è NVM not available"
      fi
      
      # Enhanced PATH setup with multiple fallbacks
      if [ -n "$SAVED_NPM_BIN" ]; then
        export PATH="$SAVED_NPM_BIN:$PATH"
        echo "‚úÖ Added saved npm bin to PATH: $SAVED_NPM_BIN"
      fi
      
      # Try current npm bin as fallback
      CURRENT_NPM_BIN="$(npm bin -g 2>/dev/null || echo '')"
      if [ -n "$CURRENT_NPM_BIN" ] && [ "$CURRENT_NPM_BIN" != "$SAVED_NPM_BIN" ]; then
        export PATH="$CURRENT_NPM_BIN:$PATH"
        echo "‚úÖ Added current npm bin to PATH: $CURRENT_NPM_BIN"
      fi
      
      # Add common Claude CLI locations
      export PATH="/opt/render/.nvm/versions/node/v20.18.0/bin:/root/.nvm/versions/node/v20.18.0/bin:$PATH"
      
      # Comprehensive CLI detection and environment setup
      echo "üîç Claude CLI detection results:"
      echo "üìç which claude: $(which claude 2>/dev/null || echo 'Not found')"
      echo "üìç Saved path exists: $(test -f "$SAVED_CLI_PATH" && echo 'Yes' || echo 'No')"
      
      # Set CLAUDE_CLI_PATH environment variable for the SDK
      FINAL_CLI_PATH=""
      if [ -n "$SAVED_CLI_PATH" ] && [ -f "$SAVED_CLI_PATH" ]; then
        echo "üìç Using saved CLI executable: $SAVED_CLI_PATH"
        export CLAUDE_CLI_PATH="$SAVED_CLI_PATH"
        FINAL_CLI_PATH="$SAVED_CLI_PATH"
      else
        # Try current PATH lookup as fallback
        CURRENT_CLI_PATH="$(which claude 2>/dev/null || echo '')"
        if [ -n "$CURRENT_CLI_PATH" ]; then
          echo "üìç Using current PATH CLI: $CURRENT_CLI_PATH"
          export CLAUDE_CLI_PATH="$CURRENT_CLI_PATH"
          FINAL_CLI_PATH="$CURRENT_CLI_PATH"
        else
          echo "‚ö†Ô∏è No Claude CLI found - analysis will fail"
        fi
      fi
      
      echo "üìç Final CLAUDE_CLI_PATH: $CLAUDE_CLI_PATH"
      echo "üìç Current PATH: $PATH"
      echo "üìç Node version: $(node --version 2>/dev/null || echo 'Not available')"
      echo "üìç npm version: $(npm --version 2>/dev/null || echo 'Not available')"
      
      # Verify CLI is working before starting agent
      if [ -n "$FINAL_CLI_PATH" ] && [ -f "$FINAL_CLI_PATH" ]; then
        echo "üîß Testing Claude CLI..."
        if "$FINAL_CLI_PATH" --version >/dev/null 2>&1; then
          echo "‚úÖ Claude CLI is functional"
        else
          echo "‚ùå Claude CLI test failed"
        fi
      fi
      
      # Start the agent
      python src/research_agent.py --once
    envVars:
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: ARXIV_AGENT_EMAIL_USERNAME
        value: donvon@vonbase.com
      - key: ARXIV_AGENT_EMAIL_FROM
        value: donvon@vonbase.com
      - key: ARXIV_AGENT_LOG_LEVEL
        value: INFO
      - key: ARXIV_OUTPUT_PATH
        value: /tmp/arxiv_output
      - key: RENDER_SERVICE_TYPE
        value: background_worker
    healthCheckPath: /health
    region: oregon
    autoDeploy: true